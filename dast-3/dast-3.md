## Часть 3. Дедупликация, триаж и сбор покрытия
Для оценки результатов фаззинг-тестирования требуется:
- собрать покрытие кода, достигаемое выбранной нами стратегией фаззинга
- провести анализ сгенерированных падений (crashes) и зависаний (hangs)

В ходе выполнения заданий 3 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания;
- сгенерированный HTML-отчет с анализом покрытия проекта из части 2;
- скриншоты запущенного процесса фаззинга libvirt с помощью AFLplusplus;
- директория casr-out, содержащая результаты анализа утилитой CASR;
- скриншот анализа указанной сработки (открытого файла отчета с расширением `.casrep`) с помощью casr-cli;
- патч, исправляющий вызвавшую падение ошибку;

### 3.1 Сбор покрытия
Для сбора покрытия воспользуемся средствами сбора покрытия, входящими в проект llvm: https://clang.llvm.org/docs/SourceBasedCodeCoverage.html
В качестве примера используется проект cppcheck

Требуется пересобрать исследуемый в части 2 проект с инструментацией для сбора покрытия:
```
CFLAGS="-fprofile-instr-generate -fcoverage-mapping" CXXFLAGS="-fprofile-instr-generate -fcoverage-mapping" CC=clang CXX=clang++ cmake .
CFLAGS="-fprofile-instr-generate -fcoverage-mapping" CXXFLAGS="-fprofile-instr-generate -fcoverage-mapping" CC=clang CXX=clang++ make
```

Определить место хранения файлов, использующихся для сбора покрытия:
```
mkdir cov
cd cov
export LLVM_PROFILE_FILE="$(pwd)/cppcheck.profraw"
```

Затем запустить исследумый проект подавая на вход все наработанные в ходе 5-минутного фаззинг-тестирования файлы:
```
./bin/cppcheck $(find "output/default/queue" -type f) 2>&1 > /dev/null
```

Проиндексировать сгенерированный профиль:
```
llvm-profdata merge -sparse cov/cppcheck.profraw -o cov/cppcheck.profdata
```

Экспортировать в формат lcov:
```
llvm-cov export -format=lcov -instr-profile=cov/cppcheck.profdata ./bin/cppcheck > cov/cppcheck.lcov
```

Сгенерировать HTML-отчет
```
genhtml cov/cppcheck.lcov -o cov/html
```

### 3.2 Дедупликация и триаж
Поскольку у нас нет возможности быстро накопить большой корпус падений, для которого нужно было бы проводить триаж и дедупликацию, для знакомства с дедупликацией и триажом наработанных срабатываний воспользуемся инструкцией по фаззинг-тестированию libvirt, с помощью которого была обнаружена уязвимость CVE-2024-1441.
Инструкция доступна по ссылке: https://www.altlinux.org/Libvirt_fuzzing_technique
Требуется выполнить инструкции до блока Run fuzzing (включительно).

После запуска фаззинга libvirt, предлагается проанализировать наработанные за 90 дней работы данного фаззинг-теста падения, находящиеся в директории afl-out/

Для этого воспользуемся утилитой CASR.
Установим её:
```shell
# For ALT Linux
sudo apt-get install casr

# For other distros
git clone https://github.com/ispras/casr
cd casr
cargo build --release
```

Запустим анализ (обратите внимание на возможную необходимость корректировки путей):
```shell
export LD_PRELOAD=" /fuzz/preeny/src/desock.so"

casr-afl -f -i /dast-labs/afl-out/ -o /dast-labs/casr-out -t 1
```

С помощью утилиты `casr-cli` найдите среди результатов анализа сработку в файле `src/interface/interface_backend_udev.c:225` - уязвимость, эксплуатирующая это падение впоследствии и получила идентификатор CVE-2024-1441.
Подготовьте патч, исправляющий ошибку, приводящую к укзанному падению.

Если сработка в этом файле не была обнаружена после использования `casr-afl`, можно воспользоваться заранее подготовленной директорией casr-out, находящейся в папке backup.

Дополнительно:
- Попробуйте проанализировать и исправить другие прошедшие дедупликацию сработки.
