# Знакомство с DAST v3.0

## Начальные условия
Аналогичны [SAST Labs](https://gitlab.basealt.space/kuznetsovam/sast-labs) и рекомендуют (хотя и не требуют) предварительного выполнения последних.

## Часть 1. Запуск фаззинга
[AFLplusplus](https://github.com/AFLplusplus/AFLplusplus) - фаззер с открытым исходным кодом, распространяющийся под лицензией Apache-2.0.

Для знакомства с процессом фаззинга предлагается запустить фаззинг-тестирование с помощью AFLplusplus для одной из двух утилит командной строки:
- Вариант 1. [tar](https://www.gnu.org/software/tar/) - утилита GNU Project для создания архивов
- Вариант 2. [gzip](https://www.gnu.org/software/gzip/) - утилита GNU Project для сжатия файлов

В ходе выполнения заданий 1 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания;
- скриншоты запущенного процесса AFLplusplus;
- директории input/ и out/ со входными и сгенерированными фаззером файлами.

### Настройка окружения
#### Установка AFLplusplus
Установим AFLplusplus и его зависимости:
```shell
sudo apt-get install AFLplusplus llvm15.0
```

#### Установка зависимостей проекта
Требуется найти исходный код выбранной утилиты (например, на https://git.altlinux.org/gears/) и подготовить окружение согалсно требованиям (для помощи можно воспользоваться spec-файлом, использующимся при сборке).

### Сборка с инструментацией
Для сборки под контролем компилятора AFLplusplus предлагается добавлять переменные окружения `CC=afl-clang-lto CXX=afl-clang-lto++` перед командами сборки, например:
```shell
CC=afl-clang-lto CXX=afl-clang-lto++ make
```
Требуется выполнить таким образом сборку выбранной утилиты.

### Запуск фаззинг-тестирования
Создадим директорию для входных данных:
```shell
mkdir input
```
Поскольку AFLplusplus требуется хотя бы один входной фазапуск утилиты производится надйл для запуска, создадим тестовый файл:
```shell
echo "test" > input/1
```
С помощью команды `afl-fuzz` запустим фаззинг нашей программы (изменив program на наш исполняемый файл: gzip или tar)
Используемые ключи и опции:
- `-i` - путь к директории со входным корпусом;
- `-o` - путь к директории результатов работы фаззера (будет создана, если ее не было).
- `[...program's cmdline...]` - опции запуска утилиты tar/gzip. Требуется определить опции, которые позволят выполнять запуск утилиты над произвольным файлом
- `@@` - поскольку обе утилиты получают на вход файлы, вместо @@ AFLplusplus будет подставлять автосгенерированное название этого файла
```shell
afl-fuzz -i input/ -o out/ -- ./program [...program's cmdline...] @@
```

### Итог 1 части
В ходе 1 части мы научились запускать фаззинг-тестирование для утилит командной строки.

## Часть 2. Добавление входного корпуса и словаря
Важным элементом фаззинг-тестирования является правильная подготовка входного корпуса и словаря, на основе которого будет происходить генерация новых тест-кейсов.

Для знакомства с процессом подготовки входного корпуса для фаззинга предлагается запустить фаззинг-тестирование с помощью AFLplusplus для одной из двух утилит командной строки:
- Вариант 1. [xmlstarlet](https://sourceforge.net/p/xmlstar/code/ci/master/tree/) - утилита для работы с XML.
- Вариант 2. [jq](https://github.com/jqlang/jq) - утилита для работы с JSON.

В ходе выполнения заданий 2 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания;
- скриншоты запущенного процесса AFLplusplus;
- директория input/ содержащая как минимум 3 подготовленных примера входных файлов, обрабатываемых программой.
- подготовленный словарь, содержащий примеры синтаксиса обрабатываемых программой файлов.
- директория out/ со сгенерированными фаззером файлами.

## Часть 3. Дедупликация, триаж и сбор покрытия
Для оценки результатов фаззинг-тестирования требуется:
- собрать покрытие кода, достигаемое выбранной нами стратегией фаззинга
- провести анализ сгенерированных падений (crashes) и зависаний (hangs)

В ходе выполнения заданий 3 части у нас должны получиться следующие артефакты работы:
- скриншоты выполнения пунктов задания;
- сгенерированный HTML-отчет с анализом покрытия проекта из части 2;
- скриншоты запущенного процесса фаззинга libvirt с помощью AFLplusplus;
- директория casr-out, содержащая результаты анализа утилитой CASR;
- скриншот анализа указанной сработки с помощью casr-cli;
- патч, исправляющий вызвавшую падение ошибку;


### Сбор покрытия
Для сбора покрытия воспользуемся средствами сбора покрытия, входящими в проект llvm: https://clang.llvm.org/docs/SourceBasedCodeCoverage.html
В качестве примера используется проект cppcheck

Требуется пересобрать исследуемый в части 2 проект с инструментацией для сбора покрытия:
```
CFLAGS="-fprofile-instr-generate -fcoverage-mapping" CXXFLAGS="-fprofile-instr-generate -fcoverage-mapping" CC=clang CXX=clang++ cmake .
CFLAGS="-fprofile-instr-generate -fcoverage-mapping" CXXFLAGS="-fprofile-instr-generate -fcoverage-mapping" CC=clang CXX=clang++ make
```

Определить место хранения файлов, использующихся для сбора покрытия:
```
mkdir cov
cd cov
export LLVM_PROFILE_FILE="$(pwd)/cppcheck.profraw"
```

Затем запустить исследумый проект подавая на вход все наработанные в ходе 5-минутного фаззинг-тестирования файлы:
```
./bin/cppcheck $(find "output/default/queue" -type f) 2>&1 > /dev/null
```

Проиндексировать сгенерированный профиль:
```
llvm-profdata merge -sparse cov/cppcheck.profraw -o cov/cppcheck.profdata
```

Экспортировать в формат lcov:
```
llvm-cov export -format=lcov -instr-profile=cov/cppcheck.profdata ./bin/cppcheck > cov/cppcheck.lcov
```

Сгенерировать HTML-отчет
```
genhtml cov/cppcheck.lcov -o cov/html
```

### Дедупликация и триаж
Поскольку у нас нет возможности быстро накопить большой корпус падений, для которого нужно было бы проводить триаж и дедупликацию, для знакомства с дедупликацией и триажом наработанных срабатываний воспользуемся инструкцией по фаззинг-тестированию libvirt, с помощью которого была обнаружена уязвимость CVE-2024-1441.
Инструкция доступна по ссылке: https://www.altlinux.org/Libvirt_fuzzing_technique
Требуется выполнить инструкции до блока Run fuzzing (включительно).

После запуска фаззинга libvirt, предлагается проанализировать наработанные за 90 дней работы данного фаззинг-теста падения, находящиеся в директории afl-out/

Для этого воспользуемся утилитой CASR.
Установим её:
```shell
# For ALT Linux
sudo apt-get install casr

# For other distros
git clone https://github.com/ispras/casr
cd casr
cargo build --release
```

Запустим анализ (обратите внимание на возможную необходимость корректировки путей):
```shell
export LD_PRELOAD=" /fuzz/preeny/src/desock.so"

casr-afl -f -i /dast-labs/afl-out/ -o /dast-labs/casr-out -t 1
```

С помощью утилиты `casr-cli` найдите среди результатов анализа сработку в файле `src/interface/interface_backend_udev.c:225` - уязвимость, эксплуатирующая это падение впоследствии и получила идентификатор CVE-2024-1441.
Подготовьте патч, исправляющий ошибку, приводящую к укзанному падению.

Дополнительно:
- Попробуйте проанализировать и исправить другие прошедшие дедупликацию сработки.

## Changelog
* Mon Nov 11 2024 Alexander Kuznetsov <kuznetsovam@basealt.ru> v3.0
    - Добавлена 3 часть.

* Mon Oct 21 2024 Alexander Kuznetsov <kuznetsovam@basealt.ru> v2.1
    - Инвертированы варианты во 2 части.

* Mon Oct 21 2024 Alexander Kuznetsov <kuznetsovam@basealt.ru> v2.0
    - Добавлена 2 часть.

* Mon Oct 07 2024 Alexander Kuznetsov <kuznetsovam@basealt.ru> v1.0
    - Добавлена 1 часть.
